---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  tidy = TRUE
)
```

<!-- Place this tag in your head or just before your close body tag. -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

# [amapGeocode](https://github.com/womeimingzi11/amapGeocode)

<!-- badges: start -->
[![Total downloads badge](https://cranlogs.r-pkg.org/badges/grand-total/amapGeocode?color=blue)](https://CRAN.R-project.org/package=amapGeocode)
[![CRAN status](https://www.r-pkg.org/badges/version/amapGeocode)](https://CRAN.R-project.org/package=amapGeocode)
[![Lifecycle: maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![DOI](https://zenodo.org/badge/297431889.svg)](https://zenodo.org/badge/latestdoi/297431889)
<!-- badges: end -->

中文版介绍: [博客](https://blog.washman.top/post/amapgeocode-%E4%BD%BF%E7%94%A8r%E8%BF%9B%E8%A1%8C%E9%AB%98%E5%BE%B7%E5%9C%B0%E5%9B%BE%E5%9C%B0%E7%90%86%E7%BC%96%E7%A0%81-%E9%80%86%E7%BC%96%E7%A0%81.zh-hans/) or [知乎](https://zhuanlan.zhihu.com/p/264281505)

## Introduction  <img src="man/figures/hexSticker-logo.png" align="right" width="100"/>

Geocoding and Reverse Geocoding Services are widely used to provide data about coordinate and location information, including longitude, latitude, formatted location name, administrative region with different levels. There are some package can provide geocode service such as [tidygeocoder](https://CRAN.R-project.org/package=tidygeocoder), [baidumap](https://github.com/badbye/baidumap) and [baidugeo](https://github.com/ChrisMuir/baidugeo). However, some of them not always provide precise information in China, and some of them is unavailable with upgrade backend API.

amapGeocode is built to provide high precise geocoding and reverse geocoding service, and it provides an interface for the AutoNavi(高德) Maps API geocoding services. API docs can be found [here](https://lbs.amap.com/) and [here](https://lbs.amap.com/api/webservice/summary/). Here are two main functions to use are `getCoord()` which takes a character location name as an input and `getLocation()` which takes two numeric longitude and latitude values as inputs.

The `getCoord()` function extracts coordinate information from input character location name and output the result as `data.table`, `XML` or `JSON (as list)`. And the `getLocation()` function extracts location information from input numeric longitude and latitude values and output the result as `data.table`, `XML` or `JSON (as list)`. With the `data.table` format as output, it's highly readable and can be used as an alternative of `data.frame`

amapGeocode is inspired by [baidumap](https://github.com/badbye/baidumap) and [baidugeo](https://github.com/ChrisMuir/baidugeo). If you want to choose the Baidu Map API, these packages are good choices.

However, AutoNavi has significant high precise, in my case, the Results from Baidu were unsatisfactory.

## BIG NEWS: Parallel is Here!
Since `v0.5`, parallel operation finally come to `amapGeocode` with the `parallel` package as the backend. There is a really huge performance improvement for batch queries. Here is a demo from my PC with below specification.

>
  1. CPU: AMD Ryzen 3600 @ 3.6GHz (6 cores with 12 threads)
  2. RAM: 32GB DDR4 2933MHz
  3. System Disk: Sandisk Ultra 3D NVME aka. WD SN550 with 1TB
  4. OS: Windows 10 Pro @ Insider Fast Ring (Build 20257.1)
  5. Internet: CMCC @ 200Mbps from Chengdu, Sichuan, China

```{r parallel_performance_revealR, message=FALSE}
library(amapGeocode)
library(readr)
sample_site <- 
read_csv('https://gist.githubusercontent.com/womeimingzi11/0fa3f4744f3ebc0f4484a52649f556e5/raw/47a69157f3e26c4d3bc993f3715b9ba88cda9d93/sample_site.csv')

str(sample_site)

# Here is the old implement
start_time <- proc.time()
old <- lapply(sample_site$address, amapGeocode:::getCoord.individual)
proc.time() - start_time

# Here is the new implement
start_time <- proc.time()
new <- getCoord(sample_site$address)
proc.time() - start_time
```

Around 8-10 TIMES FASTER with 300 records.

All you need to do is **upgrade** `amapGeocode` to the **latest version** without changing any code!

*While parallel support is a totally threads depending operation, so you will get completely different speed on different devices.*

## Installation

You can install the released version of amapGeocode from [CRAN](https://CRAN.R-project.org/package=amapGeocode) with:
``` r
install.packages("amapGeocode")
```
To install the development version, run following command:
``` r
remotes::install_github('womeimingzi11/amapGeocode')
```

## Usage
### Geocoding
Before start geocoding and reverse geocoding, please apply a [AutoNavi Map API Key](https://lbs.amap.com/dev/). Set `amap_key` globally by following command:

```{r set amap_key, eval=FALSE, include=FALSE}
options(amap_key = 'REPLACE THIS BY YOUR KEY')
```

Then get result of geocoding, by `getCoord` function. 

```{r getCoord_to_table_as_TRUE}
library(amapGeocode)
# An individual request
res <-
  getCoord('四川省中医院')
knitr::kable(res)
# Batch requests
res <-
  getCoord(c('四川省中医院',
             '四川省人民医院',
             '成都中医药大学十二桥校区'))
knitr::kable(res)
```

The response we get from **AutoNavi Map API** is **JSON** or **XML**. For readability, we transform them to [`data.table`](https://CRAN.R-project.org/package=data.table), by setting `to_table` argument as `TRUE` by default.

If anyone want to get response as **JSON** or **XML**, just set `to_table = FALSE`. If anyone want to extract information from **JSON** or **XML**. The result can further be parsed by `extractCoord`.

```{r getCoord_to_table_as_FALSE}
# An individual request
res <-
  getCoord('成都中医药大学', output = 'XML',to_table = FALSE)
res
```

`extractCoord` is created to get a result as a data.table.

```{r extractCoord}
tb <- 
  extractCoord(res)
knitr::kable(tb)
```
### Reverse Geocoding

get result of reverse geocoding, by `getLocation` function. 

```{r getLocation_to_table_as_TRUE}
res <- 
  getLocation(104.043284, 30.666864)
knitr::kable(res)
```

```{r getLocation_to_table_as_FALSE}
res <-
   getLocation(104.043284, 30.666864, output = 'XML',to_table = FALSE)
res
```

`extractLocation` is created to get a result as a data.table.

```{r extractLocation}
tb <- 
  extractLocation(res)
knitr::kable(tb)
```

### Get Subordinate Administrative Region

get result of reverse geocoding, by `getAdmin` function.

There is a difference between getAdmin and other function, no matter the `to_table` argument is `TRUE` or `FALSE` the result won't be a jointed table by different parent administrative region. For example, with the `to_table = TRUE`, all the lower level administrative region of Province A and Province B will be binded as one data.table, respectively. But the table of province A and table of province B won't be binded further.

This is becasue, this function support different administrative region levels, bind their result is nonsense.

```{r getAdmin_to_table_as_TRUE}
res <-
  getAdmin(c('四川省','成都市','济宁市'))
knitr::kable(res)
```

```{r getAdmin_to_table_as_FALSE}
res <-
   getAdmin('四川省', output = 'XML', to_table = FALSE)
res
```

`extractAdmin` is created to get result as tibble.

```{r extractAdmin}
res
tb <- 
  extractAdmin(res)
knitr::kable(tb)
```

### Convert coordinate point from other coordinate system to AutoNavi

get result of reverse geocoding, by `convertCoord` function, here is how to convert coordinate from gps to AutoNavi.

**Please not, this is still a very experimental function because I have no experience at converting coordinates. The implementation of this input method is not as delicate as I expect. If you have any good idea, please let me know or just fork repo and pull a reques.**

```{r convertCoord_to_table_as_TRUE}
res <- 
  convertCoord('116.481499,39.990475',coordsys = 'gps')
knitr::kable(res)
```

```{r convertCoord_to_table_as_FALSE}
res <-
  convertCoord('116.481499,39.990475',coordsys = 'gps', to_table = FALSE)
res
```

`extractConvertCoord` is created to get result as data.table.

```{r extractConvertCoord}
tb <- 
  extractConvertCoord(res)
knitr::kable(tb)
```

For more functions and improvements, Coming Soon!


## FAQ

### Can I input a data.frame to have a batch request?
Yes! Feel free to input a list, a vector and a column of a table as what you do in other packages.

### What about parallel?
Yes! The parallel operation is automatic.

However, because more testing is needed, there may be some potential problems. Feel free to open an <a class="github-button" href="https://github.com/womeimingzi11/amapGeocode/issues" data-color-scheme="no-preference: light; light: light; dark: dark;" data-size="large" aria-label="Issue womeimingzi11/amapGeocode on GitHub">Issue</a>！

~~Unfortunately, there is no plan to add internal parallel support to amapGeocode. Here are some reasons:~~

~~1. The aim of amapGeocode is to create a package which is easy to use. Indeed, the parallel operation can make many times performance improvement, especially there are half million queries. However, the parallel operation often platform limited, I don't have enough time and machine to test on different platforms. In fact even in macOS, the system I'm relatively familiar with, I have already encountered a lot of weird parallel issues and I don't have the intention or the experience to fix them.~~

~~2. The queries limitation. For most of free users or developers, the daily query limitation and queries per second is absolutely enough: 30,000 queries per day and 200 queries per second. But for parallel operation, the limitation is relatively easy to exceed. For purchase developers, it may cause serious financial troubles.~~

~~So for anybody who wants to send millions of request by amapGeocode, you are welcomed to make the parallel operations manually.~~

## Bug report
It's very common for API upgrades to make the downstream application, like amapGeocode, to be unavailable. Feel free to [let me know](mailto://chenhan28@gmail.com) once it's broken or just open an <a class="github-button" href="https://github.com/womeimingzi11/amapGeocode/issues" data-color-scheme="no-preference: light; light: light; dark: dark;" data-size="large" aria-label="Issue womeimingzi11/amapGeocode on GitHub">Issue</a>.

## Acknowledgements
Hex Sticker was created by [hexSticker package](https://github.com/GuangchuangYu/hexSticker) with the world data from  [rnaturalearth](https://CRAN.R-project.org/package=rnaturalearth).

---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# [amapGeocode](https://github.com/womeimingzi11/amapGeocode)

<img src="man/figures/hexSticker-logo.png" width="150"/>
<!-- badges: start -->
<!-- badges: end -->

Geocoding and Reverse Geocoding Services are widely used to provide data about coordinate and location information, including longitude, latitude, formatted location name, administrative region with different levels. There are some package can provide geocode service such as [tidygeocoder](https://CRAN.R-project.org/package=tidygeocoder), [baidumap](https://github.com/badbye/baidumap) and [baidugeo](https://github.com/ChrisMuir/baidugeo). However, some of them not always provide precise information in China, and some of them is unavailable with upgrade backend API.

amapGeocode is built to provide high precise geocoding and reverse geocoding service, and it provides an interface for the AutoNavi(高德) Maps API geocoding services. API docs can be found [here](https://lbs.amap.com/) and [here](https://lbs.amap.com/api/webservice/summary/). Here are two main functions to use are `getCoord()` which takes a character location name as an input and `getLocation()` which takes two numeric longitude and latitude values as inputs.

The `getCoord()` function extracts coordinate information from input character location name and output the result as `tibble`, `XML` or `JSON (as list)`. And the `getLocation()` function extracts location information from input numeric longitude and latitude values and output the result as `tibble`, `XML` or `JSON (as list)`. With the `tibble` format as output, it's highly readable and easy to be used to `tidy` workflow.

This project is still in a very early stage and only the geocoding function has been developed. So all the functions may change or supersede, so it's not recommended to use this package in production environment till it goes to stable stage. When will the stable stage come? It depends my graduate progress.

amapGeocode is inspired by [baidumap](https://github.com/badbye/baidumap) and [baidugeo](https://github.com/ChrisMuir/baidugeo). If you want to choose the Baidu Map API, these packages are good choice.

However, AutoNavi has significant high precise, in my case, the Results from Baidu were unsatisfactory.

## Installation
amapGeocode may be published to [CRAN](https://CRAN.R-project.org) once the first available version been finished.

For now, please install amapGeocode from GitHub following this command:
```{r install by remotes, eval=FALSE, message=TRUE, include=TRUE}
remotes::install_github('womeimingzi11/amapGeocode')
```

<!-- You can install the released version of amapGeocode from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("amapGeocode") -->
<!-- ``` -->

## Usage
### Geocoding
Before start geocoding and reverse geocoding, please apply a [AutoNavi Map API Key](https://lbs.amap.com/dev/). Set `amap_key` globally by following command:

```{r set amap_key, eval=FALSE, include=FALSE}
options(amap_key = 'REPLACE THIS BY YOUR KEY')
```

Then get result of geocoding, by `getCoord` function. 

```{r getCoord_to_table_as_TRUE}
library(amapGeocode)
res <-
  getCoord('成都中医药大学')
knitr::kable(res)
```

The response we get from **AutoNavi Map API** is **JSON** or **XML**. For readability, we transform them to `tibble`, [a modern reimagining of the data.frame](https://tibble.tidyverse.org/), by setting `to_table` argument as `TRUE` by default.

If anyone want to get response as **JSON** or **XML**, please set `to_table = TRUE`. If anyone want to extract information from **JSON** or **XML**. The result can further be parsed by `extractCoord`.

```{r getCoord_to_table_as_FALSE}
res <-
  getCoord('成都中医药大学', output = 'XML',to_table = FALSE)
res
```

`extractCoord` is created to get result as tibble.

```{r extractCoord}
res
tb <- 
  extractCoord(res)
knitr::kable(tb)
```
### Reverse Geocoding

get result of reverse geocoding, by `getLocation` function. 

```{r getLocation_to_table_as_TRUE}
res <- 
  getLocation(104.043284, 30.666864)
knitr::kable(res)
```

The response we get from **AutoNavi Map API** is **JSON** or **XML**. For readability, we transform them to `tibble`, [a modern reimagining of the data.frame](https://tibble.tidyverse.org/), by setting `to_table` argument as `TRUE` by default.

If anyone want to get response as **JSON** or **XML**, please set `to_table = TRUE`. If anyone want to extract information from **JSON** or **XML**. The result can further be parsed by `extractLocation`.

```{r getLocation_to_table_as_FALSE}
res <-
   getLocation(104.043284, 30.666864, output = 'XML',to_table = FALSE)
res
```

`extractLocation` is created to get result as tibble.

```{r extractLocation}
tb <- 
  extractLocation(res)
knitr::kable(tb)
```

### Get Subordinate Administrative Region

get result of reverse geocoding, by `getAdmin` function. 

```{r getAdmin_to_table_as_TRUE}
res <- 
  getAdmin('四川省')
knitr::kable(res)
```

The response we get from **AutoNavi Map API** is **JSON** or **XML**. For readability, we transform them to `tibble`, [a modern reimagining of the data.frame](https://tibble.tidyverse.org/), by setting `to_table` argument as `TRUE` by default.

If anyone want to get response as **JSON** or **XML**, please set `to_table = TRUE`. If anyone want to extract information from **JSON** or **XML**. The result can further be parsed by `extractLocation`.

```{r getAdmin_to_table_as_FALSE}
res <-
   getAdmin('四川省', output = 'XML', to_table = FALSE)
res
```

`extractAdmin` is created to get result as tibble.

```{r extractAdmin}
res
tb <- 
  extractAdmin(res)
knitr::kable(tb)
```

### Convert coordinate point from other coordinate system to AutoNavi

get result of reverse geocoding, by `convertCoord` function, here is how to convert coordinate from gps to AutoNavi

```{r convertCoord_to_table_as_TRUE}
res <- 
  convertCoord('116.481499,39.990475',coordsys = 'gps')
knitr::kable(res)
```

The response we get from **AutoNavi Map API** is **JSON** or **XML**. For readability, we transform them to `tibble`, [a modern reimagining of the data.frame](https://tibble.tidyverse.org/), by setting `to_table` argument as `TRUE` by default.

If anyone want to get response as **JSON** or **XML**, please set `to_table = TRUE`. If anyone want to extract information from **JSON** or **XML**. The result can further be parsed by `extract`.

```{r convertCoord_to_table_as_FALSE}
res <-
  convertCoord('116.481499,39.990475',coordsys = 'gps', to_table = FALSE)
res
```

`extractConvertCoord` is created to get result as tibble.

```{r extractConvertCoord}
tb <- 
  extractConvertCoord(res)
knitr::kable(tb)
```

For more functions and improvements, Coming Soon!


## FAQ

### Can I input a data.frame to have a batch request?
For this moment, it only can be code by yourself manually.
However, I know this is one of the most important feature. So. I am working on it.

### What about parallel?
Unfortunately, there is no plan to add internal parallel support to amapGeocode. Here are some reasons:

1. The aim of amapGeocode is to create a package which is easy to use. Indeed, the parallel operation can make many times performance improvement, especially there are half million queries. However, the parallel operation often platform limited, I don't have enough time and machine to test on different platforms. In fact even in macOS, the system I'm relatively familiar with, I have already encountered a lot of weird parallel issues and I don't have the intention or the experience to fix them.

2. The queries limitation. For most of free users or developers, the daily query limitation and queries per second is absolutely enough: 30,000 queries per day and 200 queries per second. But for parallel operation, the limitation is relatively easy to exceed. For purchase developers, it may cause serious financial troubles.

So for anybody who wants to send millions of request by amapGeocode, you are welcomed to make the parallel operations manually.

## Bug report
It's very common for API upgrades to make the downstream application, like amapGeocode, to be unavailable. Feel free to [let me know](mailto://chenhan28@gmail.com) once it's broken or just open an issue.

## Acknowledgements
Hex Sticker was created by [hexSticker package](https://github.com/GuangchuangYu/hexSticker) with the world data from  [rnaturalearth](https://CRAN.R-project.org/package=rnaturalearth).
